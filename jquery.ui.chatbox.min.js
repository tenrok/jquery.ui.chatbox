(function(n){n.widget("ui.chatbox",{options:{id:null,title:null,user:null,hidden:!1,offset:0,width:300,messageSent:function(n,t,i){this.boxManager.addMsg(t.first_name,i)},boxClosed:function(){},boxManager:{init:function(n){this.elem=n},addMsg:function(t,i){var u=this,s=u.elem.uiChatboxLog,r=document.createElement("div"),f,e,o;s.append(r);n(r).hide();f=!1;t?(e=document.createElement("b"),n(e).text(t+": "),r.appendChild(e)):f=!0;o=document.createElement(f?"i":"span");n(o).text(i);r.appendChild(o);n(r).addClass("ui-chatbox-msg");n(r).css("maxWidth",n(s).width());n(r).fadeIn();u._scrollToBottom();u.elem.uiChatboxTitlebar.hasClass("ui-state-focus")||u.highlightLock||(u.highlightLock=!0,u.highlightBox())},highlightBox:function(){var n=this;n.elem.uiChatboxTitlebar.effect("highlight",{},300);n.elem.uiChatbox.effect("bounce",{times:3},300,function(){n.highlightLock=!1;n._scrollToBottom()})},toggleBox:function(){this.elem.uiChatbox.toggle()},_scrollToBottom:function(){var n=this.elem.uiChatboxLog;n.scrollTop(n.get(0).scrollHeight)}}},toggleContent:function(){this.uiChatboxContent.toggle();this.uiChatboxContent.is(":visible")&&this.uiChatboxInputBox.focus()},widget:function(){return this.uiChatbox},_create:function(){var t=this,s=t.options,h=s.title||"No Title",r=(t.uiChatbox=n("<div><\/div>")).appendTo(document.body).addClass("ui-widget ui-corner-top ui-chatbox").attr("outline",0).focusin(function(){t.uiChatboxTitlebar.addClass("ui-state-focus")}).focusout(function(){t.uiChatboxTitlebar.removeClass("ui-state-focus")}),i=(t.uiChatboxTitlebar=n("<div><\/div>")).addClass("ui-widget-header ui-corner-top ui-chatbox-titlebar ui-dialog-header").click(function(n){t.toggleContent(n)}).appendTo(r),l=(t.uiChatboxTitle=n("<span><\/span>")).html(h).appendTo(i),u=(t.uiChatboxTitlebarClose=n('<a href="#"><\/a>')).addClass("ui-corner-all ui-chatbox-icon ").attr("role","button").hover(function(){u.addClass("ui-state-hover")},function(){u.removeClass("ui-state-hover")}).click(function(){return r.hide(),t.options.boxClosed(t.options.id),!1}).appendTo(i),a=n("<span><\/span>").addClass("ui-icon ui-icon-closethick").text("close").appendTo(u),f=(t.uiChatboxTitlebarMinimize=n('<a href="#"><\/a>')).addClass("ui-corner-all ui-chatbox-icon").attr("role","button").hover(function(){f.addClass("ui-state-hover")},function(){f.removeClass("ui-state-hover")}).click(function(n){return t.toggleContent(n),!1}).appendTo(i),v=n("<span><\/span>").addClass("ui-icon ui-icon-minusthick").text("minimize").appendTo(f),e=(t.uiChatboxContent=n("<div><\/div>")).addClass("ui-widget-content ui-chatbox-content ").appendTo(r),y=(t.uiChatboxLog=t.element).addClass("ui-widget-content ui-chatbox-log").appendTo(e),c=(t.uiChatboxInput=n("<div><\/div>")).addClass("ui-widget-content ui-chatbox-input").click(function(){}).appendTo(e),o=(t.uiChatboxInputBox=n("<textarea><\/textarea>")).addClass("ui-widget-content ui-chatbox-input-box ui-corner-all").appendTo(c).keydown(function(i){if(i.keyCode&&i.keyCode==n.ui.keyCode.ENTER)return msg=n.trim(n(this).val()),msg.length>0&&t.options.messageSent(t.options.id,t.options.user,msg),n(this).val(""),!1}).focusin(function(){o.addClass("ui-chatbox-input-focus");var t=n(this).parent().prev();t.scrollTop(t.get(0).scrollHeight)}).focusout(function(){o.removeClass("ui-chatbox-input-focus")});i.find("*").add(i).disableSelection();e.children().click(function(){t.uiChatboxInputBox.focus()});t._setWidth(t.options.width);t._position(t.options.offset);t.options.boxManager.init(t);t.options.hidden||r.show()},_setOption:function(t,i){if(i!=null)switch(t){case"hidden":i?this.uiChatbox.hide():this.uiChatbox.show();break;case"offset":this._position(i);break;case"width":this._setWidth(i)}n.Widget.prototype._setOption.apply(this,arguments)},_setWidth:function(n){this.uiChatboxTitlebar.width(n+"px");this.uiChatboxLog.width(n+"px");this.uiChatboxInput.css("maxWidth",n+"px");this.uiChatboxInputBox.css("width",n-18+"px")},_position:function(n){this.uiChatbox.css("right",n)}})})(jQuery);